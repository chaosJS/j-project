<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>view-mvc</title>
</head>

<body>
    <div id="app">

    </div>
    <script src="https://cdn.bootcss.com/axios/0.18.0/axios.js"></script>
    <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.js"></script>
    <script>   

        let model = {
            data: {
                name: '',
                number: 0,
                id: ''
            },
            fetch(id) {
                return axios.get(`/books/${id}`)
                    .then(
                        (response) => {
                            this.data = response.data;
                            return response;
                        }
                    )
            },
            update(id, newData) {
                return axios.put(`/books/${id}`, newData)
                    .then(
                        (response) => {
                            this.data = response.data;
                            return response;
                        }
                    )
            }
        }
        let view = {
            el: '#app',
            template: `  
            <div>
                书名：__name__ 数量：
                <span id="number">__number__</span>
            </div>
            <div>
                <button id="addOne">加1</button>
                <button id="minusOne">减一</button>
                <button id="reset">归零</button>
            </div>`,
            render(data) {
                let renderedHtml = this.template.replace('__name__', data.name).replace('__number__', data.number);
                $(this.el).html(renderedHtml)
            }
        }

        let controller = {
            init({ view, model }) {
                this.view = view;
                this.model = model;
                this.view.render(this.model.data);
                this.bindEvents()
                this.model.fetch(1).then(
                    () => {
                        console.log(this.model.data);
                        this.view.render(this.model.data)
                    },
                    (err) => { console.log(err) },


                )
            },
            addOne() {
                var oldNum = $('#number').text();
                var newNum = oldNum - 0 + 1;
                this.model.update(1, { number: newNum }).then(
                    () => {
                        this.view.render(this.model.data)
                    }
                )
            },
            minusOne() {
                var oldNum = $('#number').text();
                var newNum = oldNum - 0 - 1;
                this.model.update(1, { number: newNum }).then(
                    ({ data }) => {
                        this.view.render(this.model.data)
                    }
                )
            },
            reset() {
                this.model.update(1, { number: 0 }).then(
                    ({ data }) => {
                        this.view.render(this.model.data)
                    }
                )
            },
            bindEvents() {
                $(this.view.el).on('click', '#addOne', this.addOne.bind(this))

                $(this.view.el).on('click', '#minusOne', this.minusOne.bind(this))

                $(this.view.el).on('click', '#reset', this.reset.bind(this))
            }
        }

        controller.init({ view, model })
        mockRequest();
        function mockRequest() {
            //添加响应拦截器
            axios.interceptors.response.use(function (response) {
                //对响应数据做些事
                let { config: { url, method, data } } = response;
                if (url === '/books/1' && method === 'get') {
                    return response;
                } else if (url === '/books/1' && method === 'put') {
                    response.data = Object.assign(response.data, JSON.parse(data));
                    return response;
                }
                // return response;
            }, function (error) {
                //请求错误时做些事
                return Promise.reject(error);
            });
        }
    </script>
</body>

</html>